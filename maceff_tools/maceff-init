#!/usr/bin/env bash
set -euo pipefail

# maceff-init: Initialize .maceff/ structure for MacEff development
# Creates framework/ (runtime content) and config/ (build-time settings)
#
# Usage:
#   maceff-init                    # Interactive mode (prompts before overwriting)
#   maceff-init --force-overwrite  # Non-interactive (backs up and overwrites existing .maceff/)

FORCE_OVERWRITE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --force-overwrite)
            FORCE_OVERWRITE=true
            shift
            ;;
        -h|--help)
            echo "Usage: maceff-init [--force-overwrite]"
            echo ""
            echo "Initialize .maceff/ directory structure for MacEff development."
            echo ""
            echo "Options:"
            echo "  --force-overwrite    Backup existing .maceff/ and create fresh (non-interactive)"
            echo "  -h, --help           Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: maceff-init [--force-overwrite]"
            exit 1
            ;;
    esac
done

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Detect submodule context: Are we being called from a parent repo that contains MacEff as submodule?
MACEFF_SOURCE="$REPO_ROOT"  # Default: assume running from MacEff repo itself
if [[ -d "$REPO_ROOT/MacEff/framework/policies" ]] && [[ -d "$REPO_ROOT/MacEff/framework/templates" ]]; then
    # We're in a parent repo with MacEff as submodule
    MACEFF_SOURCE="$REPO_ROOT/MacEff"
fi

# In submodule context, create .maceff at submodule location (where docker-compose.yml expects it)
# In standalone context, create .maceff at repo root
MACEFF_DIR="$MACEFF_SOURCE/.maceff"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[maceff-init]${NC} $*"
}

warn() {
    echo -e "${YELLOW}[maceff-init]${NC} $*"
}

error() {
    echo -e "${RED}[maceff-init ERROR]${NC} $*" >&2
}

# Check if .maceff/ already exists
if [[ -d "$MACEFF_DIR" ]]; then
    if [[ "$FORCE_OVERWRITE" == "true" ]]; then
        # Non-interactive: backup and proceed
        BACKUP_DIR="${MACEFF_DIR}.backup-$(date +%Y%m%d-%H%M%S)"
        warn "Directory .maceff/ already exists! (--force-overwrite specified)"
        log "Backing up to: $BACKUP_DIR"
        mv "$MACEFF_DIR" "$BACKUP_DIR"
    else
        # Interactive: require explicit flag for safety
        error "Directory .maceff/ already exists!"
        echo ""
        echo "⚠️  WARNING: Overwriting will backup existing .maceff/ but could cause data loss"
        echo "    if you have uncommitted changes or custom configurations."
        echo ""
        echo "Safer alternatives:"
        echo "  1. Backup manually: mv MacEff/.maceff MacEff/.maceff.backup"
        echo "  2. Inspect contents: ls -la MacEff/.maceff/"
        echo "  3. Remove if safe:  rm -rf MacEff/.maceff/"
        echo ""
        echo "To proceed with automatic backup, run:"
        echo "  maceff-init --force-overwrite"
        echo ""
        exit 1
    fi
fi

# Create directory structure
log "Creating .maceff/ directory structure..."

mkdir -p "$MACEFF_DIR/framework/policies/sets"
mkdir -p "$MACEFF_DIR/framework/templates"
mkdir -p "$MACEFF_DIR/framework/agent_defs"
mkdir -p "$MACEFF_DIR/config/projects"

log "  ✓ Created framework/ directories"
log "  ✓ Created config/ directories"

# Copy entire framework directory (generic - future-proof for new components)
log "Copying framework/ contents..."
if [[ "$MACEFF_SOURCE" != "$REPO_ROOT" ]]; then
    log "  ℹ Detected submodule context: using MacEff/ submodule resources"
fi

if [[ -d "$MACEFF_SOURCE/framework" ]]; then
    # Copy all framework contents recursively
    cp -r "$MACEFF_SOURCE/framework/"* "$MACEFF_DIR/framework/" 2>/dev/null || true
    log "  ✓ Copied all framework/ contents (policies, templates, commands, skills, etc.)"

    # Special handling: policies/base goes to policies/sets/base for symlink pattern
    if [[ -d "$MACEFF_DIR/framework/policies/base" ]]; then
        mkdir -p "$MACEFF_DIR/framework/policies/sets"
        mv "$MACEFF_DIR/framework/policies/base" "$MACEFF_DIR/framework/policies/sets/"
        log "  ✓ Moved policies/base → policies/sets/base (for symlink pattern)"
    fi
else
    error "framework/ directory not found in $MACEFF_SOURCE"
    exit 1
fi

# Parent repo overlay (only in submodule context)
if [[ "$MACEFF_SOURCE" != "$REPO_ROOT" ]] && [[ -d "$REPO_ROOT/framework" ]]; then
    log "Applying parent repo framework/ overlay..."

    # Copy parent framework resources, explicitly noting overwrites
    if [[ -f "$REPO_ROOT/framework/agents.yaml" ]]; then
        cp "$REPO_ROOT/framework/agents.yaml" "$MACEFF_DIR/framework/"
        warn "  ⚠ OVERLAY: agents.yaml (parent overrides submodule default)"
    fi

    if [[ -f "$REPO_ROOT/framework/projects.yaml" ]]; then
        cp "$REPO_ROOT/framework/projects.yaml" "$MACEFF_DIR/framework/"
        warn "  ⚠ OVERLAY: projects.yaml (parent overrides submodule default)"
    fi

    # Copy parent agent personalities
    if [[ -d "$REPO_ROOT/framework/agents" ]]; then
        mkdir -p "$MACEFF_DIR/framework/agents"
        cp -r "$REPO_ROOT/framework/agents/"* "$MACEFF_DIR/framework/agents/" 2>/dev/null || true
        warn "  ⚠ OVERLAY: agents/* (parent customizations added/override)"
    fi

    # Copy parent project contexts
    if [[ -d "$REPO_ROOT/framework/projects" ]]; then
        mkdir -p "$MACEFF_DIR/framework/projects"
        cp -r "$REPO_ROOT/framework/projects/"* "$MACEFF_DIR/framework/projects/" 2>/dev/null || true
        warn "  ⚠ OVERLAY: projects/* (parent customizations added/override)"
    fi

    log "  ✓ Parent overlay complete"
fi

# Create policies/current symlink
log "Creating policies/current symlink..."
if [[ -d "$MACEFF_DIR/framework/policies/sets/base" ]]; then
    (cd "$MACEFF_DIR/framework/policies" && ln -s sets/base current)
    log "  ✓ Created current → sets/base"
else
    warn "  ! base policy set not found - symlink not created"
fi

# Create config templates
log "Creating configuration templates..."

# global.env (minimal defaults)
cat > "$MACEFF_DIR/config/global.env" <<'EOF'
# MacEff Global Environment
# Variables here apply to ALL containers

# Timezone (defaults to America/New_York if not set)
MACEFF_TZ=America/New_York

# Default primary agent user
DEFAULT_PA=maceff_user001
EOF
log "  ✓ Created config/global.env"

# demo.env (project example)
cat > "$MACEFF_DIR/config/projects/demo.env" <<'EOF'
# MacEff Demo Project Environment
# Variables here apply only to demo project containers

# Project-specific settings
PROJ=demo
EOF
log "  ✓ Created config/projects/demo.env"

# config.json.example (agent configuration template)
cat > "$MACEFF_DIR/config/config.json.example" <<'EOF'
{
  "moniker": "YourAgentName",
  "agent_id": "your_agent_id",
  "session_id": "auto-detected",
  "agent_root": "auto-detected",
  "temp_root": "/tmp/macf"
}
EOF
log "  ✓ Created config/config.json.example"

# Parent config overlay (copies AFTER templates, so parent overrides defaults)
# Only applies in submodule context where parent may have project-specific configs
log "DEBUG: MACEFF_SOURCE=$MACEFF_SOURCE"
log "DEBUG: REPO_ROOT=$REPO_ROOT"
log "DEBUG: Checking if '$MACEFF_SOURCE' != '$REPO_ROOT': $([[ "$MACEFF_SOURCE" != "$REPO_ROOT" ]] && echo TRUE || echo FALSE)"
log "DEBUG: Checking if -d '$REPO_ROOT/framework/config': $([[ -d "$REPO_ROOT/framework/config" ]] && echo TRUE || echo FALSE)"

if [[ "$MACEFF_SOURCE" != "$REPO_ROOT" ]] && [[ -d "$REPO_ROOT/framework/config" ]]; then
    log "Applying parent config/ overlay..."
    cp -r "$REPO_ROOT/framework/config/"* "$MACEFF_DIR/config/" 2>/dev/null || true
    warn "  ⚠ OVERLAY: config/* (parent config files override defaults)"
else
    log "  ℹ No parent config/ overlay (standalone or no parent config/)"
fi

# Create .gitkeep files to maintain structure
touch "$MACEFF_DIR/framework/.gitkeep"
touch "$MACEFF_DIR/config/.gitkeep"

# Create docker-compose.override.yml template (if not exists)
OVERRIDE_FILE="$REPO_ROOT/docker-compose.override.yml"
if [[ ! -f "$OVERRIDE_FILE" ]]; then
    log "Creating docker-compose.override.yml template..."
    cat > "$OVERRIDE_FILE" <<'EOF'
# Local Docker Compose Overrides
# This file is gitignored - customize for your development environment
#
# Docker Compose automatically merges this file with docker-compose.yml
# Use this for environment-specific volumes, ports, or configuration

services:
  maceff-sandbox:
    # Uncomment and customize as needed:
    # volumes:
    #   - "/host/path/to/data:/container/mount/point:ro"
    # ports:
    #   - "8080:8080"
EOF
    log "  ✓ Created docker-compose.override.yml template"
else
    log "  ℹ docker-compose.override.yml already exists - skipping"
fi

# Display success message
echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}✅ MacEff initialization complete${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "${BLUE}Framework content copied to:${NC} .maceff/framework/"
echo "  • Policies:  .maceff/framework/policies/sets/base/"
echo "  • Templates: .maceff/framework/templates/"
if [[ -d "$MACEFF_DIR/framework/agent_defs" ]] && [[ -n "$(ls -A "$MACEFF_DIR/framework/agent_defs" 2>/dev/null)" ]]; then
    echo "  • Agent Defs: .maceff/framework/agent_defs/"
fi
echo ""
echo -e "${BLUE}Configuration files created:${NC} .maceff/config/"
echo "  • global.env           - Environment variables for all containers"
echo "  • projects/demo.env    - Project-specific environment"
echo "  • config.json.example  - Agent configuration template"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "  1. (Optional) Review and customize files in .maceff/config/"
echo -e "  2. Build container: ${GREEN}make build${NC}"
echo -e "  3. Start services:  ${GREEN}make up${NC}"
echo ""
echo -e "${BLUE}To customize policies/templates:${NC}"
echo -e "  • Edit files in .maceff/framework/"
echo -e "  • For running containers: ${GREEN}make framework-upgrade${NC}"
echo ""
echo -e "${BLUE}Architecture:${NC}"
echo -e "  • ${BLUE}framework/${NC} = Runtime content (mounted in dev, baked in deploy)"
echo -e "  • ${BLUE}config/${NC}    = Build-time settings (host-only)"
echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
