#!/usr/bin/env bash
set -euo pipefail

# policy-sync: Copy version-controlled policies to .maceff/framework/
# Bind mount makes changes immediately visible in container (no docker cp needed)

SET_NAME="${1:-base}"
REPO_ROOT="$(cd "$(dirname "$0")"/../.. && pwd)"
SRC_DIR="$REPO_ROOT/policies/${SET_NAME}"
DEST_DIR="$REPO_ROOT/.maceff/framework/policies/sets/${SET_NAME}"
POLICIES_ROOT="$REPO_ROOT/.maceff/framework/policies"

if [[ ! -d "$SRC_DIR" ]]; then
  echo "error: source policy set not found: $SRC_DIR" >&2
  echo "       (looking for version-controlled policies in repo)" >&2
  exit 1
fi

if [[ ! -d "$REPO_ROOT/.maceff/framework" ]]; then
  echo "error: .maceff/framework/ not initialized" >&2
  echo "       run: make init" >&2
  exit 1
fi

echo "Syncing policies from version control to framework..."
echo "  Source: policies/${SET_NAME}/"
echo "  Dest:   .maceff/framework/policies/sets/${SET_NAME}/"

# Create destination directory
mkdir -p "$DEST_DIR"

# Copy files from version control to .maceff/framework/
rsync -av --delete "$SRC_DIR/" "$DEST_DIR/"

# Update current symlink
ln -sfn "sets/${SET_NAME}" "$POLICIES_ROOT/current"

echo "âœ… Policies synced (bind mount makes them immediately visible in container)"
echo "   Current: .maceff/framework/policies/current -> sets/${SET_NAME}"
ls -1 "$POLICIES_ROOT/current/"
