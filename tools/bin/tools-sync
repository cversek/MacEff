#!/usr/bin/env bash
set -euo pipefail

CONTAINER="${CONTAINER_NAME:-maceff-sandbox}"
SRC_DIR="$(cd "$(dirname "$0")"/../src && pwd)"
DEST_DIR="/opt/tools/src"

if [[ ! -d "$SRC_DIR" ]]; then
  echo "error: source tools directory not found: $SRC_DIR" >&2
  exit 1
fi

if ! docker inspect -f '{{.State.Running}}' "$CONTAINER" >/dev/null 2>&1; then
  echo "error: container '$CONTAINER' not running. Try: make up" >&2
  exit 1
fi

echo "Syncing macf_tools package to container..."

# Ensure destination parent exists
docker exec -u 0 "$CONTAINER" bash -lc "
  set -e
  install -d -o root -g root -m 755 /opt/tools
"

# Copy source directory
docker cp "$SRC_DIR/." "$CONTAINER:$DEST_DIR/"

# Reinstall package in container's venv
echo "Reinstalling macf_tools package..."
docker exec "$CONTAINER" bash -lc "
  set -e
  /opt/maceff-venv/bin/pip install -e /opt/tools
  echo 'âœ… macf_tools package updated'
  macf_tools --version
"
