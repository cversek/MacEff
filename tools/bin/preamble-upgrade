#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Source common config for PA username
source "${SCRIPT_DIR}/common.sh"

# Accept optional PA username argument
PA_USER="${1:-${PA}}"
CONTAINER="${CONTAINER_NAME:-maceff-sandbox}"

if ! docker inspect -f '{{.State.Running}}' "$CONTAINER" >/dev/null 2>&1; then
  echo "error: container '$CONTAINER' not running. Try: make up" >&2
  exit 1
fi

echo "Upgrading preamble for PA user: ${PA_USER}"

# Step 1: Sync latest templates to container
echo "[1/2] Syncing templates..."
"${SCRIPT_DIR}/template-sync"

# Step 2: Run agent init inside container as PA user
echo "[2/2] Running agent init (preserves user content above boundary)..."
docker exec -u "${PA_USER}" "$CONTAINER" bash -lc "
  set -e
  macf_tools agent init --yes
"

echo "âœ… Preamble upgrade complete"
echo "   User content above boundary marker preserved"
echo "   Framework sections below boundary updated"
