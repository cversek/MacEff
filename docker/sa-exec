#!/usr/bin/env bash
set -euo pipefail
# Usage: sa-exec <workdir> <logfile> -- <command...>
WD="$1"; shift
LOG="$1"; shift
[[ "${1:-}" == "--" ]] && shift || { echo "usage: sa-exec <workdir> <logfile> -- <command...>" >&2; exit 2; }

# Only allow PA agent trees
case "$WD" in
  /home/maceff_user*/agent/subagents/*) ;;
  *) echo "unsafe workdir: $WD" >&2; exit 1 ;;
esac

umask 027
mkdir -p -- "$(dirname "$LOG")"
cd "$WD"

# Detached login shell; append output to LOG
setsid -f bash -lc "$* >> \"$LOG\" 2>&1" </dev/null >/dev/null 2>&1 || true
